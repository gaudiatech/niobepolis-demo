import json
import re

import katagames_engine as kengi
import katagames_sdk as katasdk

import defs
import glvars


# - aliases
pygame = kengi.pygame
ReceiverObj = kengi.event.EventReceiver
EngineEvTypes = kengi.event.EngineEvTypes

# variables for the current script)
ingame_console = None
binded_state = None
isomap_viewer = None
to_edit = None
my_x, my_y = 0, 0  # old offset for using the camera (deprecated, I think)
posdecor = list()
vscr_size = None
strcutter = False
leaving_niobe = False

# - constants
CODE_GRASS = 203  # deprecated
BG_COLOR = (40, 40, 68)
CON_FONT_COLOR = (13, 253, 8)
WARP_BACK = [2, 'editor']


# extra parsing func (for the ig console), lets you call func like: name(arg1,...,argn)
re_function = re.compile(r'(?P<name>\S+)(?P<params>[\(].*[\)])')


# ---- start hack: this is for not using the .json file from disk ------
def _decode_hxd(x):
    return bytes.decode(bytes.fromhex(x))


# this str contains the whole map for niobepolis...
def get_frozen_json_txt():
    hxd_json_snapshot = '7b2022636f6d7072657373696f6e6c6576656c223a2d312c0a2022686569676874223a32302c0a2022696e66696e697465223a66616c73652c0a20226c6179657273223a5b0a20202020202020207b0a2020202020202020202264617461223a5b362c20362c20392c20392c20392c20392c20362c20362c20362c20362c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20392c20392c20392c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20392c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20362c20392c20392c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20392c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20392c20392c20362c20362c20362c20362c20362c20362c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20362c20392c20392c20392c20392c20392c20392c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20392c20392c20362c20362c20362c20362c20362c20362c20392c20392c20392c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20362c20392c20395d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a342c0a202020202020202020226e616d65223a2254696c65204c617965722034222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a31352c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a20202020202020202022647261776f72646572223a22746f70646f776e222c0a202020202020202020226964223a352c0a202020202020202020226e616d65223a224f626a656374204c617965722031222c0a202020202020202020226f626a65637473223a5b5d2c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a226f626a65637467726f7570222c0a2020202020202020202276697369626c65223a747275652c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20302c20382c20382c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20302c20382c20382c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20302c20302c20382c20382c20302c20382c20382c20302c20302c20302c20302c20302c20302c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20302c20302c20382c20382c20302c20382c20382c20302c20302c20302c20302c20302c20302c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20332c20302c20302c20302c20302c20302c20332c20332c20332c20302c20322c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20332c20302c20302c20302c20302c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20302c20302c20302c20302c20302c20332c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20332c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20372c20323134373438333635332c20302c20302c20302c20302c20302c20302c20332c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20382c20382c20302c20302c20302c20302c20302c20352c20302c20302c20372c20372c20382c20382c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20382c20382c20302c20302c20302c20302c20302c20302c20302c20302c20352c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20382c20382c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20382c20382c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a312c0a202020202020202020226e616d65223a2254696c65204c617965722031222c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20302c20302c20322c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20322c20302c20302c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20312c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20372c20342c20342c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20382c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20382c20382c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20352c20342c20322c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20382c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a322c0a202020202020202020226e616d65223a2254696c65204c617965722032222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d31362c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20342c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a332c0a202020202020202020226e616d65223a2254696c65204c617965722033222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d33322c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a362c0a202020202020202020226e616d65223a2254696c65204c617965722035222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d34382c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a372c0a202020202020202020226e616d65223a2254696c65204c617965722036222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d36342c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20322c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a382c0a202020202020202020226e616d65223a2254696c65204c617965722037222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d38302c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a392c0a202020202020202020226e616d65223a2254696c65204c617965722038222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d39362c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d2c200a20202020202020207b0a2020202020202020202264617461223a5b302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20302c20305d2c0a20202020202020202022686569676874223a32302c0a202020202020202020226964223a31302c0a202020202020202020226e616d65223a2254696c65204c617965722039222c0a202020202020202020226f666673657478223a302c0a202020202020202020226f666673657479223a2d3131322c0a202020202020202020226f706163697479223a312c0a2020202020202020202274797065223a2274696c656c61796572222c0a2020202020202020202276697369626c65223a747275652c0a202020202020202020227769647468223a33302c0a2020202020202020202278223a302c0a2020202020202020202279223a300a20202020202020207d5d2c0a20226e6578746c617965726964223a31312c0a20226e6578746f626a6563746964223a322c0a20226f7269656e746174696f6e223a2269736f6d6574726963222c0a202272656e6465726f72646572223a2272696768742d646f776e222c0a202274696c656476657273696f6e223a22312e382e32222c0a202274696c65686569676874223a33322c0a202274696c6573657473223a5b0a20202020202020207b0a20202020202020202022636f6c756d6e73223a332c0a202020202020202020226669727374676964223a312c0a20202020202020202022696d616765223a2273707269746573686565742e706e67222c0a20202020202020202022696d616765686569676874223a3134342c0a20202020202020202022696d6167657769647468223a3139322c0a202020202020202020226d617267696e223a302c0a202020202020202020226e616d65223a2273796e632d74696c65736574222c0a2020202020202020202273706163696e67223a302c0a2020202020202020202274696c65636f756e74223a392c0a2020202020202020202274696c65686569676874223a34382c0a2020202020202020202274696c657769647468223a36342c0a202020202020202020227472616e73666f726d6174696f6e73223a0a2020202020202020202020207b0a202020202020202020202020202268666c6970223a747275652c0a2020202020202020202020202022707265666572756e7472616e73666f726d6564223a66616c73652c0a2020202020202020202020202022726f74617465223a66616c73652c0a202020202020202020202020202276666c6970223a66616c73650a2020202020202020202020207d2c0a202020202020202020227472616e73706172656e74636f6c6f72223a2223666630306666220a20202020202020207d5d2c0a202274696c657769647468223a36342c0a202274797065223a226d6170222c0a202276657273696f6e223a22312e38222c0a20227769647468223a33300a7d'
    return _decode_hxd(hxd_json_snapshot)


# ---- end hack


def build_console(screen):
    global ingame_console
    screensize = screen.get_size()
    ingame_console = kengi.console.CustomConsole(
        screen,
        (0, 0, screensize[0], int(0.9 * screensize[1])),  # takes up 90% of the scr height
        functions=listing_all_console_func,
        key_calls={},
        vari={"A": 100, "B": 200, "C": 300},
        syntax={re_function: console_func},
        fontobj=pygame.font.Font(None, 21)
    )
    ingame_console.set_motd('-Niobe Polis CONSOLE rdy-\n type "help" if needed')


# --------- ignore this code, its just to un-break things
# after removing the dependency to KataSDK
class vStateMockup:  # temporary add-on to the may demo version
    def __init__(self):
        self.gamelist = ['nothing', ]

    def gamelist_func(self):
        return []


def console_func(console, match):
    funcname = match.group("name")
    if funcname in console.func_calls:
        func = console.func_calls[funcname]
    else:
        console.output('unknown function ' + funcname)
        return
    params = console.convert_token(match.group("params"))
    print(funcname, params)
    if not isinstance(params, tuple):
        params = [params]
    try:
        out = func(*params)
    except Exception as strerror:
        console.output(strerror)
    else:
        console.output(out)


# --------------- implem of console functions, docstrings are used for help ------------------START
def _gencb(x):
    global browser_res, browser_wait, strcutter
    browser_res = x
    browser_wait = False
    if strcutter:
        strcutter = False

        def _chunkstring(string, length):
            return (string[0 + i:length + i] for i in range(0, len(string), length))

        tlines = list(_chunkstring(browser_res, 4))
        dlines = list()
        cpt = 0
        while len(tlines):
            cpt += 1
            if cpt < 4:
                x = tlines.pop(0) + ' ' + tlines.pop(0) + ' ' + tlines.pop(0) + ' ' + tlines.pop(0)
            else:
                x = tlines.pop(0) + ' ' + tlines.pop(0)
            dlines.append(x)

        for one_line in dlines:
            ingame_console.output(one_line)

    else:
        ingame_console.output(browser_res)


def gamelist():
    """
    List ALL games. Use: gamelist
    :return:
    """
    if glvars.cached_gamelist:
        ret_txt = ''
        for elt in cached_gamelist:
            li = elt[0]
            if elt[1]:
                li += ' [r.-o]'
            ret_txt += li + '\n'
        return ret_txt
    return 'cannot get the list now'


def gamelist2():
    """
    List only r.-o games. Use: gamelist
    :return:
    """
    global cached_gamelist
    if cached_gamelist:
        ret_txt = ''
        for elt in cached_gamelist:
            li = elt[0]
            if elt[1]:
                li += ' [r.-o]'
                ret_txt += li + '\n'
        return ret_txt
    return 'cannot get the list now'


def stellar_console_func(subcmd):
    """
    Stellar bridge. Use: stellar CMD; CMD in {test,network,pkey}
    """
    global browser_wait, strcutter
    sbridge = katasdk.stellar
    if 'test' == subcmd:
        ret = sbridge.test_connection()

        def _proc_stellartest_result(x, consol):
            consol.output("Freighter plugin's ready!" if bool(x) else "Freighter plugin not available.")

        _proc_stellartest_result(ret, ingame_console)

    elif 'network' == subcmd:
        browser_wait = True
        sbridge.get_network(_gencb)

    elif 'pkey' == subcmd:
        browser_wait = True
        strcutter = True
        sbridge.get_pkey(_gencb)
    else:
        return 'error: stellar cmd, cf. help stellar'


def tp(gametag):
    """
    Teleport to another world. Use: tp gametag
    :param gametag:
    :return:
    """
    # check if it exists
    if not katasdk.vmstate.has_game(gametag):
        return 'game not found!'
    else:
        glvars.interruption = [2, gametag]
    return 'teleporting...'


def add(a, b):
    """
    Basic addition op! Use: add a b
    """
    return a + b


def mul(a, b):
    """
    Basic multiplication op! Use: mul a b
    """
    y = float(a) * float(b)
    if round(y) == y:
        return int(y)
    return y


def size():
    """
    Info about screen dimension. Use: size
    """
    w, h, = kengi.get_surface().get_size()
    return str(w) + ' ' + str(h)


def cedit(cname):  # -------------------- experimental ----------------
    """
    Edit cartridge code. Use: edit cartname
    """
    def _cedit_creation(saisie):
        global to_edit
        if saisie == 'yes':
            print('file created: ', cname)
            to_edit = cname

    def _cedit_readonly(saisie):
        global to_edit
        if saisie == 'yes':
            print('read-only mode open: ', cname)
            to_edit = cname

    global to_edit
    if not katasdk.vmstate.has_game(cname):
        ingame_console.cb_func = _cedit_creation
        return 'cartridge doesnt exist, create it? yes/no'
    if katasdk.vmstate.has_ro_flag(cname):
        ingame_console.cb_func = _cedit_readonly
        return 'r.-o cartridge: U wont be able to save, view code anyway? yes/no'
    else:
        to_edit = cname
        return f'editor opens {cname}...'


def erase(cname):
    """
    Erase all source-code in a cartridge (set things to default). Use: erase cartName
    :param cname:
    :return:
    """
    # - handling case read-only stuff!
    if not katasdk.vmstate.has_game(cname):
        return 'Not found'
    if katasdk.vmstate.has_ro_flag(cname):
        return 'Rejected: r.-o /protected cartridge'
    katasdk.vmstate.persist_functions['erase_cart'](cname)
    return 'Reset op. OK'


def clonec(cname1, cname2):
    """
    Create a cartridge by cloning an existing cartridge. Use: clone cartNamA cartNamB
    """
    def _clonec_overwrite(saisie):
        global to_edit
        if saisie == 'yes':
            katasdk.vmstate.persist_functions['clone_cart'](cname1, cname2)
            ingame_console.output('cloning done.')

    if not katasdk.vmstate.has_game(cname1):
        return 'Not found'
    if katasdk.vmstate.has_ro_flag(cname2):
        return 'Rejected: target cartridge is r.-o /protected'
    if katasdk.vmstate.has_game(cname2):
        ingame_console.cb_func = _clonec_overwrite
        return 'Target cartridge already exists, overwrite? yes/no'

    katasdk.vmstate.persist_functions['clone_cart'](cname1, cname2)
    return 'cloning done.'


def dohalt():
    """
    Exit app. Use: halt
    """
    global leaving_niobe
    leaving_niobe = True
    CgmEvent = kengi.event.CgmEvent
    kengi.event.EventManager.instance().post(CgmEvent(EngineEvTypes.GAMEENDS))
    return 'quit niobe requested.'


listing_all_console_func = {  # IMPORTANT REMINDER!!
    # All functions listed here need to RETURN smth and they
    # need to have 1 line of docstring, and include a
    # "Use: xxx aa bb"
    # part at the end, otherwise the cmd "help cmd_name" would crash the soft!
    "add": add,
    # clear
    # echo
    "clone": clonec,
    "edit": cedit,
    "erase": erase,
    "gamelist": gamelist,
    # help
    "mul": mul,
    "scrsize": size,
    "templates": gamelist2,  # like gamelist but shows only r.-o games
    "tp": tp,
}


def webctx():
    return katasdk.runs_in_web()


if not webctx():
    listing_all_console_func["halt"] = dohalt
else:
    listing_all_console_func["stellar"] = stellar_console_func

# --------------- implem of console functions, docstrings are used for help ------------------END

# - charge tuiles syndicate, exploite un mapping code <> surface contenant tile image -
# we need to do it in a stupid way,
# due to how the ROM pseudo-compil works (=>detects raw strings for filepaths, moves assets)
# code2filename = {
#     35: PALIAS['t035'],
#     92: PALIAS['t092'],
#     160: PALIAS['t160'],
#     182: PALIAS['t182'],
#     183: PALIAS['t183'],
#     198: PALIAS['t198'],
#     203: PALIAS['t203'],
# }
# code2tile_map = dict()
# def _loadstuff():
#     for code, fn in code2filename.items():
#         code2tile_map[code] = pygame.image.load(fn)
#
#     for obj in code2tile_map.values():
#         obj.set_colorkey('#ff00ff')


class ExtraLayerView(ReceiverObj):
    def __init__(self, cons):
        super().__init__()
        self.console = cons

    def proc_event(self, ev, source=None):
        if ev.type == EngineEvTypes.PAINT:
            self.console.draw()  # console draw


def load_isometric_map(csv=False):
    # no compression used
    kengi.isometric.model.IsometricLayer.flag_csv = csv  # notice the iso engine that our .json stores uncompressed data

    if not webctx():
        # classic way to load map --
        print('load isometric map from regular .JSON')
        with open('assets/test_map0.json', 'r') as ff:
            jdict = json.load(ff)
    else:
        # alternative way: from frozen json
        jdict = json.loads(get_frozen_json_txt())

    return kengi.isometric.model.IsometricMap.from_json_dict(['assets', ], jdict)


def init_tilemap_etc(screen):
    global tilemap, avatar_m, isomap_viewer
    global mger, lu_event, paint_event, wctrl

    tilemap = load_isometric_map(csv=True)

    avatar_m = Character(10.5, 10.5)
    # # better display, cosmetic change here
    # avatar_m.ox = 0
    # avatar_m.oy = -8

    # add the avatar to the map
    list(tilemap.objectgroups.values())[0].contents.append(avatar_m)

    isomap_viewer = kengi.isometric.IsometricMapViewer(  # TODO unify
        tilemap, screen,
        up_scroll_key=pygame.K_UP,
        down_scroll_key=pygame.K_DOWN,
        left_scroll_key=pygame.K_LEFT,
        right_scroll_key=pygame.K_RIGHT
    )
    isomap_viewer.turn_on()
    # debugviewer = DebugV()
    # debugviewer.turn_on()

    # using a cursor -> YE
    # cursor_image = pygame.image.load("assets/(niobepolis)half-floor-tile.png").convert_alpha()
    # cursor_image.set_colorkey((255, 0, 255))
    # viewer.cursor = kengi.isometric.IsometricMapQuarterCursor(0, 0, cursor_image, tilemap.layers[1])

    # camera focus avatar
    isomap_viewer.set_focused_object(avatar_m)
    # avatar_m.x += 1  # center the camera, now

    # chunk taken from PBGE, also it sets key repeat freq.
    # - disabled bc of web ctx BUGS! event manager cannot set repeating event, yet
    #    pygame.time.set_timer(pygame.USEREVENT, int(1000 / 35))
    # pygame.key.set_repeat(200, 75)

    # TODO port Pbge to kengi CogObj+EventReceiver+event system,
    #  so we can avoid using pygame.USEREVENT and viewer() like here

    wctrl = WorldCtrl()
    wctrl.turn_on()


class ExtraGuiLayerCtrl(ReceiverObj):
    def __init__(self, cons):
        super().__init__()
        if cons is None:
            raise ValueError('need a real instance of ingame console')
        self.console = cons
        self.mode = 'legacy'  # you can set this var to 'modern' to use Terminal events instead of F1 to open

    def proc_event(self, ev, source=None):
        global t_map_changed

        self.console.process_input([ev, ])  # ne sais pas cmt gerer ca autrement

        if ev.type == pygame.KEYUP:
            pass
            # keys = pygame.key.get_pressed()
            # if (not keys[pygame.K_DOWN]) and (not keys[pygame.K_UP]):
            #     dy = 0
            # if (not keys[pygame.K_LEFT]) and (not keys[pygame.K_RIGHT]):
            #     dx = 0

        elif ev.type == pygame.KEYDOWN:
            if self.mode == 'legacy' and ev.key == pygame.K_F1:
                if not self.console.active:
                    self.console.activate()
                    isomap_viewer.pause_draw()
                else:
                    self.console.desactivate()
                    isomap_viewer.resume_draw()
            elif self.mode == 'modern' and ev.key == pygame.K_ESCAPE:
                if self.console.active:
                    self.console.desactivate()

        elif ev.type == defs.MyEvTypes.TerminalStarts:
            self.console.activate()

        elif ev.type == defs.MyEvTypes.SlotMachineStarts:
            self.pev(EngineEvTypes.PUSHSTATE, state_ident=defs.GameStates.Poker)

        elif ev.type == EngineEvTypes.LOGICUPDATE:
            if binded_state and (to_edit is not None):
                binded_state.cedit_arg = to_edit  # commit name of the file to be edited to VMstate
                glvars.interruption = WARP_BACK

            if leaving_niobe:
                glvars.interruption = [1, None]

            # - old system for moving the camera
            # my_x += dx
            # my_y += dy

            # - mutating map periodically
            # tnow = ev.curr_t
            # if t_map_changed is None:
            #     t_map_changed = tnow
            #     dt = 0

            # else:
            #     dt = tnow - t_map_changed
            # if dt > 3.0:
            #    themap.shuffle()
            #    t_map_changed = tnow


class Character(kengi.isometric.model.IsometricMapObject):
    def __init__(self, x, y):
        super().__init__()
        self.x = x
        self.y = y

        self.surf = pygame.image.load("assets/sys_icon.png").convert_alpha()
        self.ht = pygame.image.load("assets/half-floor-tile.png").convert_alpha()
        self.ht.set_colorkey((255, 0, 255))
        # self.surf.set_colorkey((0,0,255))
        self.ox = self.oy = 0

    def __call__(self, dest_surface, sx, sy, mymap):
        mydest = self.ht.get_rect(midbottom=(sx, sy))
        dest_surface.blit(self.ht, mydest)
        mydest = self.surf.get_rect(midbottom=(sx + self.ox, sy + self.oy))
        dest_surface.blit(self.surf, mydest)


class WorldCtrl(ReceiverObj):
    def __init__(self):
        super().__init__()

    def proc_event(self, ev, source=None):
        global keep_going, isomap_viewer

        if ev.type == EngineEvTypes.LOGICUPDATE:
            pass
            # [] temp disabled camera scrolling for speed matters
            # keys = pygame.key.get_pressed()
            # if keys[pygame.K_UP]:
            #     viewer.scroll_to(0)
            # elif keys[pygame.K_DOWN]:
            #     viewer.scroll_to(2)
            # if keys[pygame.K_RIGHT]:
            #     viewer.scroll_to(1)
            # elif keys[pygame.K_LEFT]:
            #     viewer.scroll_to(3)

        elif ev.type == pygame.MOUSEBUTTONDOWN:
            pass
            # [] temp disabled av movement using the mouse, for demo simplicity
            # mouse_x, mouse_y = kengi.core.proj_to_vscreen(pygame.mouse.get_pos())
            # tx, ty =
            #   viewer.map_x(mouse_x, mouse_y, return_int=False), viewer.map_y(mouse_x, mouse_y, return_int=False)
            # print(tx, ty)
            # avatar_m.x, avatar_m.y = tx, ty

        elif ev.type == pygame.KEYDOWN:
            delta_pos_coord = 0.5
            # -- avatar movement via arrow keys
            if ev.key == pygame.K_RIGHT and avatar_m.x < tilemap.width - 2.2:
                avatar_m.x += delta_pos_coord
            elif ev.key == pygame.K_UP and avatar_m.y > -0.5:
                avatar_m.y -= delta_pos_coord
            elif ev.key == pygame.K_LEFT and avatar_m.x > -0.5:
                avatar_m.x -= delta_pos_coord
            elif ev.key == pygame.K_DOWN and avatar_m.y < tilemap.height - 2.2:
                avatar_m.y += delta_pos_coord
